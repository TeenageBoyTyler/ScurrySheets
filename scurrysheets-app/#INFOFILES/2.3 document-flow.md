# Document Management Flow

## Overview
The Document Management interface serves as the central hub for all document-related activities, combining search, viewing, organization, and management functions. The design prioritizes simplicity while providing powerful document management capabilities in a single, unified experience.

## Default View: My Documents
**Fullscreen document archive**

- Search bar prominently displayed at top
- Chronological grid view of all user documents
- Date grouping headers by Month and Year only (e.g., "May 2025", "April 2025")
- Documents displayed in grid under their respective month/year sections
- **Virtualized grid rendering** for smooth scrolling with large collections using svelte-virtual-list
- **Segmented loading** for performance with large document collections
- Each image displays its currently assigned tags with pen/edit icon
- Selection mechanism:
  - Tap/click to select
  - Multiple selection enabled
- Batch action bar appears when items selected:
  - Edit Tags (applies to all selected)
  - Delete
  - Create PDF
- **Implementation**:
  - Svelte component with reactive stores
  - Google Drive API for document retrieval with Supabase Database for metadata
  - TailwindCSS for responsive grid layout
  - Selection state managed via Svelte stores

## Search Functionality
**Integrated search capabilities**

- Search triggered by typing in search bar
- When search is initiated, any active tag filters are temporarily cleared
- Results replace chronological view while search is active
- "Back to All Documents" button appears when in search results
- Same grid layout and selection mechanism as default view
- All batch operations remain available in search results
- Tag filtering becomes available again after search results appear (to refine results)
- No results state with helpful suggestions when appropriate
- **Implementation**:
  - Reactive search with Svelte stores
  - Debounced input handling for performance
  - Supabase Database search with full-text search capabilities
  - SvelteKit loading states for improved UX
  - SEO handling with proper SvelteKit head metadata

## Unified Search Capabilities

The search system provides a single, unified search experience that seamlessly covers:
- Text content from OCR (Google Cloud Vision)
- Document tags
- Metadata (filenames, dates)

Users don't need to specify what type of content they're searching for - the system intelligently searches across all content types and ranks results by relevance using Supabase's search capabilities.

### OCR and Quota Management
- OCR operations performed during upload are monitored via Cloud Monitoring API
- Real-time quota tracking ensures operations stay within free tier (1,000 units/month)
- Usage dashboard available in Profile section with visual indicators
- Search capabilities use pre-extracted text to avoid additional API calls
- Zero API costs for document searching and viewing
- **Implementation**: Supabase Edge Functions for quota monitoring

## Tag Management Interface
**Dual-purpose filter bar**

- Prominently displayed in document view
- **Filter Mode** (default):
  - Shows all available tags as colored chips
  - Tap/click tags to filter documents (shows only documents with selected tags)
  - Multiple tags can be selected (shows documents with ANY of the selected tags)
  - Active filters clearly indicated with visual highlighting
  - "Clear Filters" button appears when filters are active
  - **Implementation**: 
    - Svelte stores for tag selection state
    - Reactive filtering with derived stores
    - Efficient querying with Supabase Database

- **Search Interaction**:
    - When search is initiated, all tag filters are temporarily cleared
    - Search shows ALL matching documents regardless of tags 
    - After search results appear, tag filtering becomes available again
    - Users can then apply tag filters to narrow down search results
    - Creates natural "broad-to-narrow" discovery process
  
- **Management Mode**:
  - Toggle button switches filter bar to tag management interface
  - "Tag Management" toggle prominently displayed in filter area
  - When in Management Mode, shows edit/delete options for each tag
  - Each tag shown with name, color, and usage count
  - "Add New Tag" button always visible in Management Mode
  - Edit functionality:
    - Edit icon opens a modal overlay for tag editing
    - "Edit [Tag Name]" header in modal
    - Tag name input field with auto-focus
    - Color selection palette (vibrant color options)
    - Usage statistics displayed (e.g., "Used in 24 documents")
    - "Save" button with confirmation animation
    - Cancel option to return to document view
    - **Implementation**: 
      - Svelte modal component with form validation
      - SvelteKit form actions for tag updates
      - Reactive updates with Svelte stores
  - Delete functionality:
    - Delete shows confirmation with special handling:
    - If tag is the only tag on some documents, offers options:
      - Cancel deletion
      - Assign replacement tag
    - Ensures no documents are left without tags
    - **Implementation**: 
      - Tag integrity checks with Supabase Database queries
      - Svelte stores for reactive updates
      - Supabase Realtime for cross-device synchronization
  - Smooth transition animation between modes using Svelte transitions

## Tag Creation
**Inline tag editor**

- Opens as a modal overlay within document view
- When creating: "Create New Tag" header
- Tag name input field with auto-focus
- Color selection palette (vibrant color options)
- "Save" button with confirmation animation
- Cancel option to return to document view
- **Implementation**: 
  - Svelte component with form validation
  - SvelteKit form actions for tag creation
  - Svelte transitions for animations
  - Supabase Database for tag storage
  - Supabase Realtime for cross-device synchronization

## Individual Document Tag Editing
**Accessed via pen icon on each document**

- Opens a modal dialog specific to that document
- Currently applied tags shown as selected colored chips
- All available tags displayed
- Full editing capabilities:
  - Tap applied tag to REMOVE it (prevented if it's the only tag)
  - Tap unused tag to ADD it
  - "Add New Tag" option with color selection
- "Save Changes" button to confirm modifications
- System ensures at least one tag is always maintained
- Simple, focused interface for quick individual edits
- **Implementation**: 
  - Tag state managed via Svelte stores
  - Tag changes immediately reflected in UI through reactivity
  - SvelteKit form actions for tag updates
  - Google Drive API for updating document metadata
  - Supabase Database for tag storage

## Batch Tag Operations
**Accessed via "Edit Tags" button in batch action bar**

- Modal dialog opens when "Edit Tags" button is clicked
- Simple count indicator (e.g., "Editing tags for 7 documents")
- All available tags displayed as colored chips
- Tap chips to ADD tags to all selected documents
- "Remove All Tags" button with ability to select a replacement tag
- "Add New Tag" option with color selection
- "Apply Changes" button to confirm modifications
- System ensures at least one tag is always maintained for each document
- Designed for efficient operations on multiple documents at once
- **Implementation**:
  - Svelte component with reactive state
  - Batch operations performed in background with Web Workers
  - Progress indicators for batch processing
  - Supabase Database batch operations
  - Supabase Edge Functions for complex batch operations

## PDF Creation
**Generation from selected documents**

### PDF Document Requirements:
- Format: A4 (Portrait orientation)
- Content: Images only (no text)
- Image placement:
  - All selected images/documents must be fitted to portrait A4 format
  - Images must be inserted borderless (edge-to-edge)
  - All content must maintain proper aspect ratio when fitted

### PDF Creation Process:
- PDF is generated locally on the user's device (not stored in cloud)
- Clean, minimal processing indicator during local generation
- Success message with download button when complete
- On mobile: Options to share, save to device, or open
- On desktop: Automatic download or open in new tab
- After download return to document view
- Temporary PDF file is removed from memory after download/sharing
- **Implementation**:
  - pdf-lib or jsPDF for document generation
  - Web Workers for background processing
  - Svelte progress indicators
  - SvelteKit download helpers
  - Browser File System Access API for direct save on supported browsers

## GitHub Codespaces Development

- Full configuration for GitHub Codespaces development
- `.devcontainer` configuration for consistent development environment
- Environment variables for API keys and endpoints
- Mock data generation for testing document management
- Local development server with HMR
- Configured VS Code extensions for Svelte development
- Testing tools for simulating document operations
- Supabase local development setup

## Related Documentation
- For tag management architecture, see the Tag Management System section in global-systems.md
- For error handling standards, see the Error Handling Guidelines section in global-systems.md
- For cloud storage structure, see the Cloud Storage System section in global-systems.md
- For OCR processing details, see the Document Processing Pipeline section in global-systems.md
- For performance considerations, see the Performance Optimizations section in global-systems.md