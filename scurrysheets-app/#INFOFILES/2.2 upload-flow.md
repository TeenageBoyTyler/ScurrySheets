# Updated Upload Process

## Overview
The upload process provides a streamlined workflow for adding worksheets with handwriting removal capabilities. The interface prioritizes simplicity while guiding users through logical steps.

## Step 1: Selection Method
**Fullscreen selection interface**

- Clean, centered interface with two prominent options:
  - "Select Files" button (opens native file browser)
  - "Take Photo" button (mobile only, opens camera)
- Large drop zone area with subtle animation for drag and drop (desktop)
- Simple animations for hover/focus states using Svelte transitions
- Files are selected through browser dialog, camera, or drop action
- **Temporary Storage**: Selected files temporarily stored in browser using Svelte stores and Supabase Storage
- **Supported formats**: jpg, jpeg, png, gif, bmp, pdf, heic, heif, webp only
- Unsupported formats rejected with standard filetype error message
- **Error handling**: Follows standard error handling guidelines (see Error Handling Guidelines in global-systems.md)
- **Connection handling**: Files remain in temporary storage if connection is lost
- **Implementation**: 
  - Svelte component with file input and svelte-gestures for drag/drop
  - SvelteKit form actions for file handling
  - Supabase Storage for temporary file storage

## Background Processing
**Initial conversion process**

- Immediately after file selection, background processing begins
- See Document Processing Pipeline - Intake Phase (document-processing.md) for technical details
- User proceeds without waiting for complete processing
- No visible interface for small files, subtle indicator for large files
- **Connection handling**: If connection lost during this phase, processing pauses
- Files remain available in temporary storage for retry when connection restored
- **Implementation**: 
  - Web Workers for background processing
  - Svelte stores for process state management
  - Progress indicators with Svelte transitions

## Step 2: Preview & Confirm (Batch Uploads Only!)
**Fullscreen preview interface**

- Grid of thumbnails showing all selected documents (after conversion)
- "Add More" button to return to Step 1 without losing current selection
- "Remove" option on each thumbnail (X icon or swipe action)
- "Continue" button to proceed to tagging/editing
- "Cancel" button to abort the upload process and return to home
- Shows count and basic info (e.g., "5 images selected")
- Responsive grid layout (more columns on larger screens)
- **Only shown for multiple file uploads** (single uploads skip to Step 3)
- **Connection handling**: Selected files remain in temporary storage if connection is lost
- After confirmation, users will edit and tag each document individually in sequence
- **Implementation**: 
  - Svelte component with TailwindCSS grid layout
  - svelte-virtual-list for efficient rendering of large collections
  - Transition animations using Svelte's built-in transition system
  - Cancel button with clear confirmation dialog

## Step 3: Edit & Tag
**Combined editing and tagging interface**

- Main editor with worksheet image on left
- Tag selection panel on right
- **For batch uploads**:
  - Each document in batch is edited individually in sequence
  - Navigation controls (Previous/Next) allow moving between documents
  - Progress indicator shows current position in batch (e.g., "2 of 5")
  - All documents must be individually edited before proceeding to Step 4
- **Handwriting removal implementation**:
  - "Remove Handwriting" toggle button
  - When activated for first time:
    - Shows loading indicator
    - Checks if operation is within monthly quota limits (1,000 units)
    - Sends current image to Google Cloud Vision API via Supabase Edge Function using user's API key
    - Displays actual processed result (not a preview)
    - Blocks operation with clear message if quota would be exceeded
  - Toggle switches between original and processed versions
  - Both versions (original and processed) stored temporarily during editing
  - All edits (brightness, contrast, etc.) apply to both versions
  - No additional API calls needed unless user explicitly refreshes
  - Each refresh counts as a new Vision API call against user's quota
  - Quota check performed before each Vision API operation
- **Editing capabilities**:
  - Brightness (0-200%)
  - Contrast (0-200%)
  - Grayscale toggle
  - 90Â° rotation options
  - Horizontal/vertical flipping
  - Cropping with aspect ratios
- **Tagging options**:
  - Colored chips for existing tags from the global tag collection
  - "Add New Tag" button with color picker
  - At least one tag mandatory (adheres to Tag Integrity Rules)
  - Tags created here are immediately available throughout application via Svelte stores
- "Save" button enabled only after tagging
- "Cancel" button always available to abort the current operation and return to previous step
- For batch uploads, "Save" commits changes to current document and advances to next, or proceeds to Step 4 if all documents are complete
- **Connection handling**: 
  - Edited files and processed versions stored temporarily in Supabase Storage and Svelte stores
  - If connection lost during editing, local changes are preserved
  - API calls for handwriting removal require active connection
  - Clear notification provided if connection lost during API call
- When final "Save" is clicked, all edited images are generated and sent to processing
- **Implementation**: 
  - FabricJS or Canvas API for image editing wrapped in Svelte components
  - Svelte stores for state management
  - Tag system integrated with Supabase Database
  - Background processing with Web Workers
  - Supabase Edge Functions for Vision API processing
  - Cancel confirmation dialog with options to discard or save progress

## Step 4: Processing
**Dynamic processing interface**

- Clean fullscreen view with circular loading indicator
- Progress bar showing overall completion percentage
- Status text indicating current processing step
- Quota check before OCR processing to ensure operation is within monthly limits
- Real-time API usage monitoring via Cloud Monitoring API
- Operation blocked with clear message if quota would be exceeded
- Batch processing optimized to stay within free tier (1,000 units/month)
- See Document Processing Pipeline - OCR Phase (document-processing.md) for technical details
- Automatic redirect to success screen when complete
- **Connection handling**:
  - All files processed locally first
  - If connection lost during processing, entire batch is held temporarily
  - If connection lost during upload to cloud, no files are saved to cloud
  - All-or-nothing approach: either all files upload successfully, or none are saved
- Clear fullscreen message if connection lost: "Lost Connection. Your processed files are safely stored temporarily. Click to resume upload when connected."
  - Return to appropriate step based on when connection was lost
- **Error handling**: Follows standard error handling guidelines (see Error Handling Guidelines in global-systems.md)
- **Implementation**:
  - Supabase Edge Functions for OCR processing
  - Google Drive API for cloud storage
  - Progress indicators with Svelte animation
  - Background processing with Web Workers
  - SvelteKit page transitions for navigation between steps

## Step 5: Success Confirmation
**Completion screen**

- Clean fullscreen view with minimal elements
- Success message with document count
- Quick action options:
  - "View Documents" (goes to document archive)
  - "Upload More" (returns to Step 1)
- **Implementation**: 
  - Simple Svelte component with TailwindCSS styling
  - SvelteKit navigation with proper routing
  - Success animation with Svelte transitions

## GitHub Codespaces Development

- Full configuration for GitHub Codespaces development
- `.devcontainer` configuration for consistent development environment
- Environment variables for local development
- Mock data for testing upload flow
- Local development server with HMR
- Configured VS Code extensions for Svelte development

## Related Documentation
- For document processing details, see Document Processing Pipeline (document-processing.md)
- For tag management architecture, see the Tag Management System section in global-systems.md
- For error handling standards, see the Error Handling Guidelines section in global-systems.md
- For network interruption handling, see the Internet Connectivity Requirements section in global-systems.md