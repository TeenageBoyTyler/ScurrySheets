# Document Processing Pipeline

## Overview
The document processing pipeline handles all image conversion, optimization, OCR extraction, and handwriting removal. The pipeline is divided into phases that align with specific steps in the upload flow, ensuring efficient processing while minimizing user wait times.

## Processing Phases

### Intake Phase (During Upload Background Processing)
- **Trigger**: Immediately after files are selected
- **User visibility**: Largely invisible (background process)
- **Temporary storage**: Files stored temporarily using Svelte stores and Supabase Storage
- **Format conversions**:
  - All image formats converted to standardized JPG
  - PDF files converted to JPG images
  - Multi-page PDFs split into individual JPG images
  - HEIC/HEIF/WebP files converted to JPG
- **Image optimizations** based on size:
  - Small files (< 800px): Max 200KB, 95% quality
  - Medium files (800-1500px): Max 500KB, 90% quality
  - Large files (1500-2500px): Max 1.5MB, 85% quality
  - Extra Large files (2500-4000px): Max 2.5MB, 85% quality
- **Output**: Standardized images ready for preview and editing
- **Connection handling**: 
  - Process pauses if connection lost
  - Files remain in temporary storage for retry when connection restored
- **Implementation**: 
  - Web Workers for background processing
  - browser-image-compression for optimization
  - heic2any for HEIC/HEIF conversion
  - PDF.js for PDF processing
  - Svelte stores for state management

### Handwriting Removal Processing (During Edit & Tag)
- **Trigger**: When user activates "Remove Handwriting" toggle in Edit & Tag interface
- **User visibility**: Loading indicator followed by actual processed result
- **Processing details**:
  - Non-destructive approach maintains both original and processed versions
  - Full Google Cloud Vision API processing using user's personal API key
  - Processing via Supabase Edge Functions
  - Results cached temporarily to avoid redundant API calls and reduce user costs
  - All editing operations (crop, brightness, etc.) applied to both versions
  - Toggle switches between original and processed base images
- **Implementation workflow**:
  1. **Initial Toggle Activation**:
     - Current image state sent to Google Cloud Vision API via Supabase Edge Function
     - Loading indicator displayed during processing (Svelte transition)
     - API distinguishes between printed and handwritten text
     - Handwritten elements selectively removed
     - Processed image returned and displayed
     - Both versions stored temporarily in Supabase Storage and Svelte stores
  
  2. **Subsequent Editing**:
     - All transformations (crop, rotate, etc.) tracked as operations list
     - Operations applied in real-time to either base image (original or processed)
     - Switching between versions doesn't require new API calls
     - Edits preserved across version toggling
     - FabricJS or Canvas API for image manipulation
  
  3. **Explicit Refresh Option**:
     - Users can request new API processing if needed
     - Useful after significant edits that might affect handwriting detection
     - Replaces previous processed version with new result
     - Each refresh counts as a new Vision API call against user's quota
  
- **Connection Requirements**:
  - Active internet connection required for initial API processing
  - Valid Google Vision API key required from user
  - Once processed, version switching works offline
  - Editing operations function without connection
  - If connection lost during API call, graceful fallback to original version with retry option
- **Output**: Actual processed image with handwriting removed
- **Connection handling**: 
  - Requires active connection for API processing
  - Offline toggling between versions once processed

### OCR Phase (During Upload Step 4)
- **Trigger**: After user clicks "Save" in Edit & Tag screen
- **User visibility**: Visible processing screen with progress indicators
- **Processing sequence**:
  1. **Final Image Generation**:
     - All user edits applied to create final image
     - Uses handwriting-removed version if toggle was enabled
     - Image saved in final format with all modifications
     - All processing occurs locally first
  
  2. **OCR Processing**:
     - Google Cloud Vision API processes the final saved image via Supabase Edge Function
     - Uses user's personal API key stored in Supabase Database
     - Performs text extraction from the document
     - Full-page text content captured with positioning data
     - Processing time: 1-3 seconds per standard document
     - Each document processed counts against the user's Vision API quota
  
  3. **Metadata Creation**:
     - Document ID generation
     - Creation timestamp recording
     - Tag association (from user selections)
     - Storage of extracted OCR text
     - Edit history initialization
     - Image dimension and format details
     - Metadata managed via Svelte stores during local processing
     - Metadata synchronized with Supabase Database for fast querying
  
  4. **Thumbnail Generation**:
     - Creation of optimized preview images
     - Multiple resolution thumbnails for different UI contexts
     - Web Workers handle thumbnail generation in background
     - Thumbnails stored in Supabase Storage for fast access
  
  5. **Cloud Upload**:
     - All-or-nothing approach for batch uploads
     - Final images uploaded to Google Drive (.scurrysheets/uploads/) only after all processing complete
     - Metadata JSON files created and uploaded (.scurrysheets/documents/)
     - Metadata also stored in Supabase Database for fast queries
     - Thumbnails uploaded (.scurrysheets/thumbnails/) and cached in Supabase Storage
     - Tag usage counts updated in global tag collection
     - If connection lost during upload, no files are saved to cloud
     - Process must restart when connection restored
     - Google Drive API used directly for file uploads

- **Output**: Fully processed documents with extracted text stored in cloud

## Technical OCR Implementation
- Google Cloud Vision API handles all OCR processing via user-provided API keys
- Text extraction optimized for document/worksheet scenarios 
- **OCR Capabilities**:
  - Text recognition optimized for document and worksheet content
  - Text positioning data preserved with original document layout
  - Typical accuracy: >95% for printed text, >85% for handwritten text
  - Multi-language support with automatic language detection
  - All text indexed for full-document search in Supabase
  
- **Handwriting Removal Implementation**:
  - Fully integrated during the Edit & Tag phase
  - Direct Google Cloud Vision API processing via Supabase Edge Functions
  - Detection of handwritten elements using confidence scores and character patterns
  - Precise identification of handwriting vs. printed text
  - Content-aware removal that preserves underlying document structure
  - Smart background reconstruction using surrounding content
  - Both original and processed versions preserved temporarily
  - Non-destructive editing approach allows toggling between versions
  
  - **Use Cases**:
    - Worksheet cleanup (remove answers while preserving questions)
    - Form extraction (remove handwritten entries while keeping form structure)
    - Document restoration (remove annotations from underlying content)

- **Quality Considerations**:
  - High-contrast documents yield best results
  - Performance may vary with handwriting style and document complexity
  - Settings in Profile section affect processing behavior
  - API usage efficiency optimized to minimize user costs

- **User-Provided API Key Architecture**:
  - Users must provide their own Google Cloud project
  - Enable the Vision API in their GCP console
  - Generate an API key with appropriate restrictions
  - Store key in Supabase Database under their user ID with RLS protection
  - All Vision API requests use the user's personal key
  - Benefits: 
    - No server-side billing for Vision API usage
    - Works with Supabase free tier plan
    - Users have full control over their API quotas
    - Transparent usage tracking in users' Google Cloud consoles
  - API calls routed through Supabase Edge Functions for security

## Connection Failure Handling
- **During Intake Phase**:
  - Selected files remain in temporary storage (Supabase Storage and Svelte stores)
  - Process can resume from current state when connection restored
  
- **During Edit & Tag**:
  - Edits are preserved temporarily
  - If connection lost during handwriting API processing, operation pauses
  - Both versions (original and processed if available) maintained in temporary storage
  - Editing operations can continue on available versions
  
- **During OCR Phase**:
  - All processing occurs locally first
  - Files held in temporary storage until successful upload
  - If connection lost during final upload to cloud, no files are saved
  - All-or-nothing approach for batch uploads
  - Clear error message displayed: "Lost Connection. Your edited files are preserved temporarily. Only upload needs to be resumed when connected."
  - Implementation uses Svelte toast notifications and fullscreen overlays

## Performance Considerations
- Processing time varies based on:
  - Document size and complexity
  - Selected processing options (especially handwriting removal)
  - Cloud service availability
  - Network bandwidth for final upload
- Batch processing optimized for multiple documents
- Background processing minimizes user wait times
- Local processing reduces dependency on continuous connectivity
- Web Workers used for CPU-intensive operations
- SvelteKit's optimized bundle sizes improve initial load performance
- Svelte's efficient update mechanism for reactive UI during processing

## GitHub Codespaces Development

- Full configuration for GitHub Codespaces development
- `.devcontainer` configuration for consistent development environment
- Environment variables for API keys and endpoints
- Mock data generation for testing document processing
- Local development server with HMR
- Configured VS Code extensions for Svelte development
- Testing tools for simulating API responses
- Supabase local development setup for Edge Functions